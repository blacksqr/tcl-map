<?xml version="1.0" encoding="iso-8859-1"?>
<!-- $Id: make_dll.html,v 1.9 2006/02/08 06:00:01 dav480 Exp $ -->
<html>
  <head>
    <meta name="generator"
    content="HTML Tidy for Windows (vers 1 September 2005), see www.w3.org" />
    <title>NAP Library: make_dll.tcl</title>
  </head>
  <body>
  <center>
    <h2>Interfacing NAP to a DLL based on C or Fortran Code</h2>
  </center>
  <h3>Table of Contents</h3>
  <ol>
    <li>
      <a href="#Introduction">Introduction</a>
    </li>
    <li>
      <a href="#make_dll">
      <code>make_dll</code> 
      <var>options</var> 
      <var>newCommand</var> 
      <var>argDec</var> 
      <var>argDec</var> 
      <var>argDec</var> &#8230;</a>
      <ul>
        <li>
          <a href="#C_example">C Example</a>
        </li>
        <li>
          <a href="#f90_example">Fortran 90 Example</a>
        </li>
      </ul>
    </li>
    <li>
      <a href="#make_dll_i">
      <code>make_dll_i</code> 
      <var>options</var> 
      <var>newCommand</var> 
      <var>argDec</var> 
      <var>argDec</var> 
      <var>argDec</var> &#8230;</a>
    </li>
  </ol>
  <h3>
    <a name="Introduction">Introduction</a>
  </h3>The file 
  <code>make_dll.tcl</code> defines procedures for automatically
  producing an interface from NAP to a 
  <em>DLL</em> (
  <em>dynamic-link library</em> or 
  <em>shared library</em>) based on C or Fortran Code. This process
  defines a new tcl command which can either be used directly or via
  another interface (written in Tcl) defining a NAP function.
  <h3>
    <a name="make_dll"> <code>make_dll</code> <var>options</var> <var>newCommand</var> <var>argDec</var> <var>argDec</var> <var>argDec</var> &#8230;</a>
  </h3>This is the standard procedure used to create a DLL.
  <p>
  <var>newCommand</var> is name of new command.</p>
  <p>Each argument-declaration 
  <var>argDec</var> is a list with the form 
  <code>{</code>
  <var>name</var> 
  <var>dataType</var> 
  <var>intent</var>
  <code>}</code> where</p>
  <ul>
    <li>
    <var>name</var> is any string (used only in error messages)</li>
    <li>
    <var>dataType</var> can be: 
    <code>c8 i8 u8 i16 u16 i32 u32 f32 f64 void</code></li>
    <li>
    <var>intent</var> can be: 
    <code>in</code> (default) or 
    <code>inout</code>. Actual 
    <code>in</code> arguments can be expressions of any type (including
    
    <code>ragged</code>) and will be converted to the specified type
    (unless this is 
    <code>void</code>).</li>
  </ul>
  <p>
  <var>options</var> are:
  <br />
  <code>-quiet</code>: Do not echo commands.
  <br />
  <code>-compile</code> 
  <var>command</var>: C compile-command with options
  <br />
  <code>-dll</code> 
  <var>fileName</var>: output filename for DLL (default: 
  <var>newCommand</var>.dll for windows, 
  <var>newCommand</var>.so for unix)
  <br />
  <code>-entry</code> 
  <var>string</var>: User-routine entry-point (default: 
  <var>newCommand</var>). Note that fortran entry points often include
  suffix &#39;_&#39;.
  <br />
  <code>-header</code> 
  <var>fileName</var>: header (
  <code>*.h</code>) filename (default: none)
  <br />
  <code>-libs</code> 
  <var>fileNames</var>: filenames of extra binary libraries (default:
  none)
  <br />
  <code>-link</code> 
  <var>command</var>: Link-command with options
  <br />
  <code>-object</code> 
  <var>fileName</var>: User-routine object-file (default: 
  <var>newCommand</var>
  <code>.obj</code> for windows, 
  <var>newCommand</var>
  <code>.o</code> for unix)
  <br />
  <code>-source</code> 
  <var>fileName</var>: Output file containing C source code of
  interface (default: 
  <var>newCommand</var>
  <code>_i.c</code>)
  <br />
  <code>-version</code> 
  <var>n.m</var>: Version number (default: 
  <code>1.0</code>)</p>
  <h4>
    <a name="C_example">C Example</a>
  </h4>The following example (under SunOS 5.8) defines a new NAP
  function 
  <code>partialProd</code> which calculates partial-products. This is
  analogous to the standard nap function 
  <code>psum</code> which calculates partial sums. The new function is
  based on the following C file 
  <code>pprod.c</code>:
  <pre>
void pprod(int *n, float *x, float *result) {
   int         i;
   float       prod = 1;

   for (i = 0; i &lt; *n; i++) {
       result[i] = prod = prod * x[i];
   }
}
</pre>
  <pre>
% exec cc -c -o pprod.o pprod.c
% make_dll pprod {n i32 in} {x f32} {y f32 inout}
cc -I/sol/home/dav480/tcl/include -c pprod_i.c
ld -G -o libpprod.so pprod_i.o pprod.o  
% load ./libpprod.so                             
% proc partialProd x {
    nap &quot;result = reshape(f32(_), shape(x))&quot;
    pprod  &quot;nels(x)&quot; x result
    nap &quot;result&quot;
}
% [nap &quot;partialProd({2 1.5 3 0.5})&quot;]
2 3 9 4.5
</pre>
  <h4>
    <a name="f90_example">Fortran 90 Example</a>
  </h4>The following fortran 90 example does the same thing as the
  above C example. The f90 source code in the file 
  <code>pprod.f90</code> is:
  <pre>
subroutine pprod(n, x, result)
   integer, intent(in) :: n
   real, intent(in) :: x(n)
   real, intent(out) :: result(n)
   integer :: i
   real :: prod
   prod = 1.0
   do i = 1, n
       prod = prod * x(i)
       result(i) = prod
   end do
end subroutine pprod
</pre>
  <p>The following log was produced using the SunOS 5.8 f95 compiler.
  (Note that the entry point is &quot;<code>pprod_</code>&quot;.)</p>
  <pre>
% exec f95 -c pprod.f90
% make_dll -entry pprod_ pprod {n i32 in} {x f32} {y f32 inout}
cc -I/sol/home/dav480/tcl/include -c pprod_i.c
ld -G -o libpprod.so pprod_i.o pprod.o  
% load ./libpprod.so
% proc partialProd x {
    nap &quot;result = reshape(f32(_), shape(x))&quot;
    pprod  &quot;nels(x)&quot; x result
    nap &quot;result&quot;
}
% [nap &quot;partialProd({2 1.5 3 0.5})&quot;]
2 3 9 4.5
</pre>
  <h3>
    <a name="make_dll_i"> <code>make_dll_i</code> <var>options</var> <var>newCommand</var> <var>argDec</var> <var>argDec</var> <var>argDec</var> &#8230;</a>
  </h3>Make NAP C interface to user&#39;s C function or Fortran
  subroutine. This procedure is normally used via 
  <code>make_dll</code>, but may be used directly if you prefer to do
  your own compiling and linking. The result of 
  <code>make_dll_i</code> is the C code.
  <p>The arguments are similar to 
  <code>make_dll</code>, except that the only options are:
  <br />
  <code>-entry</code> 
  <var>string</var>: User-routine entry-point (default: 
  <var>newCommand</var>). Note that fortran entry points often include
  suffix &#39;_&#39;.
  <br />
  <code>-header</code> 
  <var>fileName</var>: header (
  <code>*.h</code>) filename (default: none)
  <br />
  <code>-version</code> 
  <var>n.m</var>: Version number (default: 
  <code>1.0</code>)</p>
  <table width="100%" border="0" cellspacing="0" cellpadding="2"
  bgcolor="#737B9C">
    <tr>
      <td align="center">
        <font color="#FFFFFF" size="-2">
          <span class="titlebar">
          <b>Author:</b> 
          <a href="http://sourceforge.net/users/dav480/">Harvey
          Davies</a> &#160; &#160; &#160; © 2002, CSIRO Australia.
          &#160; &#160; &#160; 
          <a href="http://www.csiro.au/legalnotices/disclaimer.html">Legal
          Notice and Disclaimer</a>
          <br />
          <b>CVS Version Details:</b> $Id: make_dll.html,v 1.5
          2005/12/04 03:12:23 dav480 Exp $</span>
        </font>
      </td>
    </tr>
  </table></body>
</html>
